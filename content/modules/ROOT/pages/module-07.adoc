= Lab Guide: Introducing supply chain security with ansible-sign
:doctype: book
:experimental:
:notoc:
:toc-title: Table of Contents
:nosectnums:
:icons: font

_Learn how to sign content by using ansible-sign and apply supply-chain security measures, a major Dev Tools capability._

---

== Lab Briefing

 `ansible-sign`: Utility for signing and verifying Ansible project directory contents.Project signing and verification lets you sign files in your project directory, then verify whether or not that content has changed in any way, or files have been added or removed from the project unexpectedly. To do this, you require a private key for signing and a matching public key for verifying. 


== Enhanced Developer Experience

`ansible-sign` is part of the Ansible Development Tools (ADT) suite. 

== Lab Guide: Hands-On Tasks


=== Task 1: Create a GPG key 
To use `ansible-sign` your workstation needs to have a GPG key available to cryptographically sign the content. Although it exceeds the scope of this workshop, we will create one quickly to show the end to end steps.

.  *Install pinentry-curses, a dependency for gpg*:
+
[source,bash,role=execute]
----
 sudo dnf install pinentry-curses
----

. *Create a gpg.txt file with the following content:*
[source,bash,role=execute]
----
cat >~/gpg.txt <<EOF
%echo Generating a basic OpenPGP key
Key-Type: default
Key-Length: 4096
Subkey-Type: default
Subkey-Length: default
Name-Real: workshop
Name-Comment: with no passphrase
Name-Email: student@localhost
Expire-Date: 0
%no-ask-passphrase
%no-protection
# Do a commit here, so that we can later print "done" :-)
%commit
%echo done
EOF
----


.  *Generate the gpg key:*
+
[source,bash,role=execute]
----
gpg --batch --gen-key ~/gpg.txt
----

. *Verify the key is created:*
+
[source,bash,role=execute]
----
gpg --list-secret-keys
----

=== Task 2: Supply-chain security: Signing your Ansible collection 

This task demonstrates how to cryptographically sign an Ansible collection using `ansible-sign`.

Signing is a critical step for enterprise workflows where content integrity, provenance, and trust are required, especially when publishing to Automation Hub or consuming content in controlled environments.


---

=== Prerequisites for using ansible-sign

* A GPG key already exists on the system
* You are working inside the collection repository created earlier
* The collection has been built into a distributable artifact

NOTE: This task assumes the GPG key was created in the previous step and is present.

---

=== Task 1: Create a MANIFEST.in File

. *In VS Code, create a new file called `MANIFEST.in`* in the root of you `mycollection` directory. Add the following content to it:
+
[source,bash,role=execute]
----
# Exclude .venv FIRST before any includes
global-exclude .venv
global-exclude .venv/*
prune .venv

# Exclude .git
global-exclude .git
global-exclude .git/*
prune .git

# Now include what you want
include README.md
include galaxy.yml
recursive-include plugins *
recursive-include roles *
recursive-include playbooks *
----

=== Task 2: Sign the Project with ansible-sign

. *Switch to `ade` to standard mode:* Before we can sign our packages, we need to disable editable mode to remove the recursive symlinks. 
+
[source,bash,role=execute]
----
ade install .
----

. *Now we can sign the files listed in the `MANIFEST.in`:*
+
[source,bash,role=execute]
----
ansible-sign project gpg-sign .
----
+
The output of the command above should look like this:
+
[source,bash]
----
[OK   ] GPG signing successful!
[NOTE ] Checksum manifest: ./.ansible-sign/sha256sum.txt
[NOTE ] GPG summary: signature created
----

. *Verify the files in MANIFEST.in got checksums:*
+
[source,bash,role=execute]
----
cat .ansible-sign/sha256sum.txt
----

. *Switch `ade` back to editable mode:*
+
[source,bash,role=execute]
----
ade install --editable .
----
